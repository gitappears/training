<template>
  <q-form class="column q-gutter-lg" @submit="onSubmit">
    <!-- Sección 1: Información Básica -->
    <q-card flat bordered class="q-pa-md">
      <div class="row items-center q-mb-md">
        <q-icon name="info" size="24px" color="primary" class="q-mr-sm" />
        <div class="text-h6 text-weight-medium">Información Básica</div>
      </div>

      <div class="row q-col-gutter-md">
        <div class="col-12 col-md-8">
          <q-input
            v-model="form.title"
            filled
            label="Título de la capacitación"
            placeholder="Ej: Introducción a React y TypeScript"
            :rules="[
              (val) => !!val || 'El título es obligatorio',
              (val) => (val && val.length >= 5) || 'El título debe tener al menos 5 caracteres',
              (val) => (val && val.length <= 200) || 'El título no puede exceder 200 caracteres',
            ]"
            @blur="validateTitle"
            hint="Nombre descriptivo y atractivo para la capacitación (5-200 caracteres)"
            :error-message="titleError"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="title" />
            </template>
          </q-input>
        </div>
        <div class="col-12 col-md-4">
          <q-select
            v-model="form.type"
            filled
            :options="trainingTypes"
            label="Tipo de capacitación"
            emit-value
            map-options
            :rules="[(val) => !!val || 'Seleccione un tipo']"
            hint="Tipo de certificación que otorgará"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="category" />
            </template>
          </q-select>
        </div>
      </div>

      <div class="row q-col-gutter-md q-mt-sm">
        <div class="col-12">
          <q-input
            v-model="form.description"
            type="textarea"
            filled
            autogrow
            label="Descripción"
            placeholder="Describe los objetivos, contenidos y beneficios de esta capacitación..."
            hint="Proporciona información detallada que motive a los participantes (mínimo 20 caracteres)"
            rows="4"
            :dense="false"
            :error-message="descriptionError"
            @blur="validateDescription"
          >
            <template #prepend>
              <q-icon name="description" />
            </template>
          </q-input>
        </div>
      </div>
    </q-card>

    <!-- Sección 2: Configuración y Logística -->
    <q-card flat bordered class="q-pa-md">
      <div class="row items-center q-mb-md">
        <q-icon name="settings" size="24px" color="primary" class="q-mr-sm" />
        <div class="text-h6 text-weight-medium">Configuración y Logística</div>
      </div>

      <div class="row q-col-gutter-md">
        <div class="col-12 col-md-4">
          <q-select
            v-model="form.modality"
            filled
            :options="modalities"
            label="Modalidad"
            emit-value
            map-options
            :rules="[(val) => !!val || 'Seleccione una modalidad']"
            hint="Forma en que se impartirá la capacitación"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="computer" />
            </template>
          </q-select>
        </div>
        <div v-if="false" class="col-12 col-md-4">
          <q-input
            v-model="form.location"
            filled
            label="Lugar / Enlace"
            placeholder="URL de la plataforma o dirección física"
            hint="Para modalidad online, ingresa el enlace de acceso"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="place" />
            </template>
          </q-input>
        </div>
        <div class="col-12 col-md-2">
          <q-input
            v-model.number="form.durationHours"
            type="number"
            min="0"
            step="1"
            filled
            label="Duración (horas)"
            placeholder="0"
            hint="Horas totales del curso (número entero)"
            :rules="[
              (val) => val === null || val === undefined || val === '' || (!isNaN(val) && val >= 0) || 'La duración debe ser un número mayor o igual a 0',
              (val) => val === null || val === undefined || val === '' || Number.isInteger(Number(val)) || 'La duración debe ser un número entero',
            ]"
            :dense="false"
            @update:model-value="handleDurationChange"
          >
            <template #prepend>
              <q-icon name="schedule" />
            </template>
          </q-input>
        </div>
        <div class="col-12 col-md-2">
          <q-input
            v-model.number="form.capacity"
            type="number"
            min="1"
            filled
            label="Cupos"
            placeholder="0"
            hint="Número máximo de participantes"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="people" />
            </template>
          </q-input>
        </div>
        <div class="col-12 col-md-4">
          <q-input
            v-model="form.instructor"
            filled
            label="Relator / Instructor"
            placeholder="Nombre del instructor principal"
            hint="Persona responsable de impartir la capacitación"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="person" />
            </template>
          </q-input>
        </div>
      </div>

      <div class="row q-col-gutter-md q-mt-sm">
      
        <div v-if="false" class="col-12 col-md-4">
          <q-input
            v-model="form.area"
            filled
            label="Área Responsable"
            placeholder="Ej: Desarrollo, Recursos Humanos"
            hint="Departamento o área que gestiona esta capacitación"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="business" />
            </template>
          </q-input>
        </div>
        <div class="col-12 col-md-4">
          <q-select
            v-model="form.targetAudience"
            filled
            :options="targetAudiences"
            label="Público Objetivo"
            hint="Grupo de personas a quienes está dirigida"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="groups" />
            </template>
          </q-select>
        </div>
     
        <div class="col-12 col-md-4">
          <q-input
            v-model="form.startDate"
            filled
            label="Fecha de Inicio"
            mask="####-##-##"
            hint="Cuándo comenzará la capacitación"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="event" class="cursor-pointer">
                <q-popup-proxy cover transition-show="scale" transition-hide="scale">
                  <q-date v-model="form.startDate" mask="YYYY-MM-DD">
                    <div class="row items-center justify-end">
                      <q-btn v-close-popup label="Cerrar" color="primary" flat />
                    </div>
                  </q-date>
                </q-popup-proxy>
              </q-icon>
            </template>
          </q-input>
        </div>
        <div class="col-12 col-md-4">
          <q-input
            v-model="form.endDate"
            filled
            label="Fecha de Término"
            mask="####-##-##"
            hint="Cuándo finalizará la capacitación"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="event" class="cursor-pointer">
                <q-popup-proxy cover transition-show="scale" transition-hide="scale">
                  <q-date v-model="form.endDate" mask="YYYY-MM-DD">
                    <div class="row items-center justify-end">
                      <q-btn v-close-popup label="Cerrar" color="primary" flat />
                    </div>
                  </q-date>
                </q-popup-proxy>
              </q-icon>
            </template>
          </q-input>
        </div>
      </div>
    </q-card>

    <!-- Sección 3: Recursos Multimedia -->
    <q-card flat bordered class="q-pa-md">
      <div class="row items-center q-mb-md">
        <q-icon name="image" size="24px" color="primary" class="q-mr-sm" />
        <div class="text-h6 text-weight-medium">Recursos Multimedia</div>
      </div>

      <div class="row q-col-gutter-md">
        <div class="col-12 col-md-6">
          <q-input
            v-model="form.coverImageUrl"
            filled
            label="URL de Imagen de Portada"
            placeholder="https://ejemplo.com/imagen.jpg"
            hint="Imagen que se mostrará como portada del curso (recomendado: 1200x675px)"
            :dense="false"
            @blur="validateImageUrl"
          >
            <template #prepend>
              <q-icon name="image" />
            </template>
            <template #append>
              <q-btn
                v-if="form.coverImageUrl"
                flat
                dense
                round
                icon="visibility"
                @click="showImagePreview = !showImagePreview"
              >
                <q-tooltip>Ver preview</q-tooltip>
              </q-btn>
            </template>
          </q-input>
          <div v-if="showImagePreview && form.coverImageUrl" class="q-mt-sm">
            <q-img
              :src="form.coverImageUrl"
              style="max-height: 200px; border-radius: 8px"
              placeholder-src="https://via.placeholder.com/400x225?text=Imagen+no+disponible"
            >
              <template #error>
                <div class="absolute-full flex flex-center bg-negative text-white">
                  Error al cargar imagen
                </div>
              </template>
            </q-img>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <q-input
            v-model="form.promoVideoUrl"
            filled
            label="URL de Video Promocional"
            placeholder="https://youtube.com/watch?v=..."
            hint="Video de presentación del curso (opcional)"
            :dense="false"
          >
            <template #prepend>
              <q-icon name="videocam" />
            </template>
          </q-input>
        </div>
      </div>
    </q-card>

    <!-- Sección 4: Contenido del Curso -->
    <q-card flat bordered class="q-pa-md">
      <div class="row items-center q-mb-md">
        <q-icon name="menu_book" size="24px" color="primary" class="q-mr-sm" />
        <div class="text-h6 text-weight-medium">Contenido del Curso</div>
      </div>

      <!-- Subsección 4A: Videos del Curso (Solo URLs) -->
      <div class="videos-section q-mb-lg">
        <div class="row items-center q-mb-md">
          <q-icon name="videocam" size="20px" color="purple" class="q-mr-sm" />
          <div class="text-subtitle1 text-weight-medium">Videos del Curso</div>
          <q-space />
          <q-btn
            outline
            color="purple"
            icon="add"
            label="Agregar Video"
            size="sm"
            @click="showAddVideoDialog = true"
          />
        </div>

        <q-banner dense class="bg-purple-1 text-purple q-mb-md" rounded>
          <template #avatar>
            <q-icon name="info" color="purple" />
          </template>
          <div class="text-body2">
            Los videos se reproducen directamente en la plataforma. Ingresa URLs de YouTube, Vimeo u otros servicios compatibles.
          </div>
        </q-banner>

        <!-- Lista de videos -->
        <div v-if="videos.length === 0" class="empty-materials q-pa-lg text-center">
          <q-icon name="videocam" size="48px" color="grey-5" class="q-mb-md" />
          <div class="text-body2 text-grey-7 q-mb-sm">No hay videos agregados</div>
          <div class="text-caption text-grey-6">Agrega videos que se reproducirán en la plataforma</div>
        </div>

        <div v-else class="materials-list q-gutter-md">
          <q-card
            v-for="(video, index) in videos"
            :key="video.id || `video-${index}`"
            flat
            bordered
            class="material-card"
          >
            <q-card-section>
              <div class="row items-center q-gutter-md">
                <div class="material-preview-container">
                  <q-icon name="videocam" size="48px" color="purple" />
                </div>
                <div class="col material-info">
                  <div class="text-body1 text-weight-medium q-mb-xs">
                    {{ video.name }}
                  </div>
                  <q-chip color="purple" text-color="white" size="sm" dense>
                    Video
                  </q-chip>
                  <div v-if="video.description" class="text-caption text-grey-6 q-mt-xs">
                    {{ video.description }}
                  </div>
                  <div class="text-caption text-grey-6 q-mt-xs">
                    {{ video.url }}
                  </div>
                </div>
                <div class="material-actions">
                  <q-btn-group flat>
                    <q-btn
                      icon="edit"
                      flat
                      round
                      dense
                      @click="editVideo(index)"
                    >
                      <q-tooltip>Editar</q-tooltip>
                    </q-btn>
                    <q-btn
                      icon="delete"
                      flat
                      round
                      dense
                      color="negative"
                      @click="removeVideo(index)"
                    >
                      <q-tooltip>Eliminar</q-tooltip>
                    </q-btn>
                  </q-btn-group>
                </div>
              </div>
            </q-card-section>
          </q-card>
        </div>
      </div>

      <q-separator class="q-my-lg" />

      <!-- Subsección 4B: Archivos e Imágenes (Upload) -->
      <div class="files-section">
        <div class="row items-center q-mb-md">
          <q-icon name="attach_file" size="20px" color="primary" class="q-mr-sm" />
          <div class="text-subtitle1 text-weight-medium">Archivos e Imágenes</div>
          <q-space />
          <q-btn
            outline
            color="primary"
            icon="upload_file"
            label="Subir Archivo"
            size="sm"
            @click="showUploadFileDialog = true"
          />
        </div>

        <q-banner dense class="bg-info-1 text-info q-mb-md" rounded>
          <template #avatar>
            <q-icon name="info" color="info" />
          </template>
          <div class="text-body2">
            Sube PDFs e imágenes que se almacenarán en el servidor. Los archivos estarán disponibles en:
            <code>localhost:3000/storage/materials</code>
          </div>
        </q-banner>

        <!-- Lista de archivos subidos -->
        <div v-if="files.length === 0" class="empty-materials q-pa-lg text-center">
          <q-icon name="attach_file" size="48px" color="grey-5" class="q-mb-md" />
          <div class="text-body2 text-grey-7 q-mb-sm">No hay archivos subidos</div>
          <div class="text-caption text-grey-6">Sube PDFs e imágenes para enriquecer el curso</div>
        </div>

        <div v-else class="materials-list q-gutter-md">
          <q-card
            v-for="(file, index) in files"
            :key="file.id || `file-${index}`"
            flat
            bordered
            class="material-card"
          >
            <q-card-section>
              <div class="row items-center q-gutter-md">
                <div class="material-preview-container">
                  <MaterialViewer
                    :material="file"
                    :show-preview="true"
                    :allow-download="false"
                    class="material-preview"
                  />
                </div>
                <div class="col material-info">
                  <div class="text-body1 text-weight-medium q-mb-xs">
                    {{ file.name }}
                  </div>
                  <q-chip
                    :color="getMaterialTypeColor(file.type)"
                    text-color="white"
                    size="sm"
                    dense
                  >
                    {{ getMaterialTypeLabel(file.type) }}
                  </q-chip>
                  <div v-if="file.description" class="text-caption text-grey-6 q-mt-xs">
                    {{ file.description }}
                  </div>
                </div>
                <div class="material-actions">
                  <q-btn-group flat>
                    <q-btn
                      icon="edit"
                      flat
                      round
                      dense
                      @click="editFile(index)"
                    >
                      <q-tooltip>Editar</q-tooltip>
                    </q-btn>
                    <q-btn
                      icon="delete"
                      flat
                      round
                      dense
                      color="negative"
                      @click="removeFile(index)"
                    >
                      <q-tooltip>Eliminar</q-tooltip>
                    </q-btn>
                  </q-btn-group>
                </div>
              </div>
            </q-card-section>
          </q-card>
        </div>
      </div>
    </q-card>

    <!-- Sección 5: Evaluación (RF-09) - Siempre inline -->
    <q-card flat bordered class="q-pa-md q-mt-md evaluation-section">
      <div class="row items-center q-mb-md">
        <q-icon
          name="quiz"
          size="24px"
          :color="hasEvaluation ? 'primary' : 'warning'"
          class="q-mr-sm"
        />
        <div class="text-h6 text-weight-medium">Evaluación</div>
        <q-badge v-if="!hasEvaluation" color="warning" class="q-ml-md">
          Requerida
        </q-badge>
      </div>

      <q-banner
        dense
        class="bg-primary-1 text-primary q-mb-md"
        rounded
      >
        <template #avatar>
          <q-icon name="info" color="primary" />
        </template>
        <div class="text-body2">
          <strong>Evaluación obligatoria (RF-09):</strong> Cada capacitación requiere una evaluación.
          Créela aquí con preguntas y opciones de respuesta.
        </div>
      </q-banner>

      <!-- Formulario de evaluación inline -->
      <div class="q-mt-md">
          <q-banner dense class="bg-info-1 text-info q-mb-md" rounded>
            <template #avatar>
              <q-icon name="info" color="info" />
            </template>
            <div class="text-body2">
              Cree una evaluación completa con preguntas y opciones. La evaluación se creará junto con la capacitación.
            </div>
          </q-banner>

          <!-- Formulario de evaluación -->
          <div class="q-gutter-md" v-if="form.evaluationInline">
            <q-input
              v-model="form.evaluationInline.titulo"
              filled
              label="Título de la evaluación *"
              hint="Nombre descriptivo de la evaluación"
              :rules="[(val) => !!val || 'El título es obligatorio']"
              :dense="false"
            >
              <template #prepend>
                <q-icon name="title" />
              </template>
            </q-input>

            <q-input
              v-model="form.evaluationInline.descripcion"
              filled
              type="textarea"
              label="Descripción"
              hint="Descripción opcional de la evaluación"
              :dense="false"
              rows="3"
            />

            <div class="row q-col-gutter-md q-mt-sm">
              <div class="col-12 col-md-6">
                <q-input
                  v-model.number="form.evaluationInline.tiempoLimiteMinutos"
                  filled
                  type="number"
                  label="Tiempo límite (minutos)"
                  hint="Deje vacío para sin límite"
                  :dense="false"
                  min="1"
                >
                  <template #prepend>
                    <q-icon name="schedule" />
                  </template>
                </q-input>
              </div>
              <div class="col-12 col-md-6">
                <q-input
                  v-model.number="form.evaluationInline.intentosPermitidos"
                  filled
                  type="number"
                  label="Intentos permitidos *"
                  hint="Número de veces que se puede intentar"
                  :dense="false"
                  min="1"
                >
                  <template #prepend>
                    <q-icon name="repeat" />
                  </template>
                </q-input>
              </div>
            </div>

            <div class="row q-col-gutter-md">
              <div class="col-12 col-md-6">
                <q-input
                  :model-value="calculatedPuntajeTotal"
                  filled
                  type="number"
                  label="Puntaje total *"
                  hint="Calculado automáticamente: suma de los puntajes de todas las preguntas"
                  :dense="false"
                  readonly
                  class="readonly-field"
                >
                  <template #prepend>
                    <q-icon name="calculate" />
                  </template>
                </q-input>
              </div>
              <div class="col-12 col-md-6">
                <q-input
                  v-model.number="form.evaluationInline.minimoAprobacion"
                  filled
                  type="number"
                  label="Mínimo para aprobar (%) *"
                  hint="Porcentaje mínimo para aprobar"
                  :dense="false"
                  min="0"
                  max="100"
                  step="0.01"
                >
                  <template #prepend>
                    <q-icon name="check_circle" />
                  </template>
                </q-input>
              </div>
            </div>

            <div class="row q-col-gutter-md q-mt-sm">
              <div class="col-12 col-md-6">
                <q-toggle
                  v-model="form.evaluationInline.mostrarResultados"
                  label="Mostrar resultados al finalizar"
                  color="primary"
                />
              </div>
              <div class="col-12 col-md-6">
                <q-toggle
                  v-model="form.evaluationInline.mostrarRespuestasCorrectas"
                  label="Mostrar respuestas correctas"
                  color="primary"
                />
              </div>
            </div>

            <!-- Sección de preguntas -->
            <q-separator class="q-my-md" />
            <div class="text-subtitle1 text-weight-medium q-mb-md">
              <q-icon name="help" class="q-mr-xs" />
              Preguntas (mínimo 1 según RF-08)
            </div>

            <div
              v-for="(pregunta, preguntaIndex) in form.evaluationInline.preguntas"
              :key="preguntaIndex"
              class="q-mb-lg"
            >
              <q-card flat bordered class="q-pa-md">
                <div class="row items-center q-mb-md">
                  <div class="text-subtitle2 text-weight-medium">
                    Pregunta {{ preguntaIndex + 1 }}
                  </div>
                  <q-space />
                  <q-btn
                    v-if="form.evaluationInline.preguntas.length > 1"
                    flat
                    dense
                    round
                    color="negative"
                    icon="delete"
                    size="sm"
                    @click="removeQuestion(preguntaIndex)"
                  />
                </div>

                <div class="q-gutter-md">
                  <q-select
                    v-model.number="pregunta.tipoPreguntaId"
                    filled
                    :options="questionTypes"
                    label="Tipo de pregunta *"
                    emit-value
                    map-options
                    :rules="[(val) => !!val || 'Seleccione un tipo']"
                    :dense="false"
                  >
                    <template #prepend>
                      <q-icon name="category" />
                    </template>
                  </q-select>

                  <q-input
                    v-model="pregunta.enunciado"
                    filled
                    type="textarea"
                    label="Enunciado *"
                    hint="Texto de la pregunta"
                    :rules="[(val) => !!val || 'El enunciado es obligatorio']"
                    :dense="false"
                    rows="2"
                  />

                  <q-input
                    v-if="pregunta.tipoPreguntaId === 3"
                    v-model="pregunta.imagenUrl"
                    filled
                    label="URL de la imagen"
                    hint="URL de la imagen para preguntas de tipo imagen"
                    :dense="false"
                  >
                    <template #prepend>
                      <q-icon name="image" />
                    </template>
                  </q-input>

                  <q-input
                    v-model.number="pregunta.puntaje"
                    filled
                    type="number"
                    label="Puntaje de la pregunta"
                    hint="Puntaje que vale esta pregunta"
                    :dense="false"
                    min="0"
                    step="0.01"
                  />

                  <!-- Opciones de respuesta -->
                  <q-separator class="q-my-sm" />
                  <div class="text-body2 text-weight-medium q-mb-sm">
                    Opciones de respuesta (mínimo 1, al menos una debe ser correcta)
                  </div>

                  <div
                    v-for="(opcion, opcionIndex) in pregunta.opciones"
                    :key="opcionIndex"
                    class="q-mb-sm"
                  >
                    <q-card flat bordered class="q-pa-sm">
                      <div class="row items-center q-gutter-sm">
                        <div class="col">
                          <q-input
                            v-model="opcion.texto"
                            filled
                            dense
                            label="Texto de la opción *"
                            :rules="[(val) => !!val || 'El texto es obligatorio']"
                          />
                        </div>
                        <div class="col-auto">
                          <q-checkbox
                            v-model="opcion.esCorrecta"
                            label="Correcta"
                            color="positive"
                          />
                        </div>
                        <div class="col-auto">
                          <q-btn
                            v-if="pregunta.opciones.length > 1"
                            flat
                            dense
                            round
                            color="negative"
                            icon="close"
                            size="sm"
                            @click="removeOption(preguntaIndex, opcionIndex)"
                          />
                        </div>
                      </div>
                    </q-card>
                  </div>

                  <q-btn
                    flat
                    dense
                    color="primary"
                    icon="add"
                    label="Agregar opción"
                    size="sm"
                    @click="addOption(preguntaIndex)"
                  />
                </div>
              </q-card>
            </div>

            <q-btn
              flat
              dense
              color="primary"
              icon="add"
              label="Agregar pregunta"
              @click="addQuestion"
            />
          </div>
        </div>
    </q-card>

    <!-- Enlaces externos (mantener compatibilidad) -->
    <q-card flat bordered class="q-pa-md q-mt-md">
      <div class="text-subtitle2 q-mb-sm text-weight-medium">
        <q-icon name="link" size="18px" class="q-mr-xs" />
        Enlaces Externos (Legacy)
      </div>
      <div v-if="form.links.length === 0" class="text-grey-6 q-mb-sm">
        No hay enlaces agregados
      </div>
      <div class="column q-gutter-sm">
        <q-card
          v-for="(link, index) in form.links"
          :key="link.id"
          flat
          bordered
          class="q-pa-sm"
        >
          <div class="row q-col-gutter-sm items-center">
            <div class="col-5">
              <q-input
                v-model="link.label"
                dense
                filled
                label="Texto del enlace"
                placeholder="Ej: Documentación oficial"
              />
            </div>
            <div class="col-6">
              <q-input
                v-model="link.url"
                dense
                filled
                label="URL"
                placeholder="https://..."
              />
            </div>
            <div class="col-auto">
              <q-btn
                dense
                flat
                round
                icon="delete"
                color="negative"
                size="sm"
                @click="removeLink(index)"
              >
                <q-tooltip>Eliminar enlace</q-tooltip>
              </q-btn>
            </div>
          </div>
        </q-card>
        <q-btn
          outline
          color="primary"
          icon="add"
          label="Agregar enlace"
          @click="addLink"
          class="q-mt-sm"
        />
      </div>
    </q-card>

    <!-- Dialog para agregar/editar video -->
    <q-dialog v-model="showAddVideoDialog">
      <q-card style="min-width: 500px">
        <q-card-section>
          <div class="text-h6">
            {{ editingVideoIndex !== null ? 'Editar Video' : 'Agregar Video' }}
          </div>
        </q-card-section>

        <q-card-section class="q-pt-none">
          <q-input
            v-model="newVideo.name"
            filled
            label="Nombre del video *"
            placeholder="Ej: Introducción al curso"
            :rules="[(val) => !!val || 'El nombre es requerido']"
            class="q-mb-md"
          />
          <q-input
            v-model="newVideo.url"
            filled
            label="URL del Video *"
            placeholder="https://youtube.com/watch?v=... o https://vimeo.com/..."
            :rules="[
              (val) => !!val || 'La URL es requerida',
              (val) => isValidVideoUrl(val) || 'URL de video no válida (YouTube, Vimeo, etc.)'
            ]"
            hint="Soporta YouTube, Vimeo y otros servicios de video"
            class="q-mb-md"
          >
            <template #append>
              <q-btn
                v-if="newVideo.url"
                flat
                dense
                round
                icon="play_circle"
                @click="previewVideo(newVideo.url)"
              >
                <q-tooltip>Previsualizar video</q-tooltip>
              </q-btn>
            </template>
          </q-input>
          <q-input
            v-model="newVideo.description"
            type="textarea"
            filled
            label="Descripción (opcional)"
            rows="2"
          />
        </q-card-section>

        <q-card-actions align="right">
          <q-btn
            flat
            label="Cancelar"
            color="grey-7"
            @click="cancelAddVideo"
          />
          <q-btn
            color="primary"
            label="Agregar"
            @click="saveVideo"
          />
        </q-card-actions>
      </q-card>
    </q-dialog>

    <!-- Dialog para subir archivo -->
    <q-dialog v-model="showUploadFileDialog">
      <q-card style="min-width: 500px">
        <q-card-section>
          <div class="text-h6">
            {{ editingFileIndex !== null ? 'Editar Archivo' : 'Subir Archivo o Imagen' }}
          </div>
        </q-card-section>

        <q-card-section class="q-pt-none">
          <q-input
            v-model="newFile.name"
            filled
            label="Nombre del archivo *"
            placeholder="Ej: Guía de estudio"
            :rules="[(val) => !!val || 'El nombre es requerido']"
            class="q-mb-md"
          />

          <q-select
            v-model="newFile.type"
            filled
            :options="fileTypes"
            label="Tipo de archivo *"
            emit-value
            map-options
            :rules="[(val) => !!val || 'Seleccione un tipo']"
            class="q-mb-md"
          />

          <q-file
            v-model="newFile.file"
            filled
            :label="getFileUploadLabel()"
            :accept="getFileAcceptTypes()"
            :max-file-size="10 * 1024 * 1024"
            @update:model-value="handleFileSelected"
            class="q-mb-md"
          >
            <template #prepend>
              <q-icon name="upload_file" />
            </template>
            <template #append>
              <q-btn
                v-if="newFile.file && isImageFile(newFile.file)"
                flat
                dense
                round
                icon="visibility"
                @click="previewFile(newFile.file)"
              />
            </template>
          </q-file>

          <!-- Preview del archivo seleccionado -->
          <div v-if="newFile.file && isImageFile(newFile.file)" class="q-mb-md">
            <q-img
              :src="getFilePreviewUrl(newFile.file)"
              style="max-height: 200px; border-radius: 8px"
            />
          </div>

          <!-- Barra de progreso de upload -->
          <q-linear-progress
            v-if="uploading"
            :value="uploadProgress"
            color="primary"
            class="q-mb-md"
          />

          <q-input
            v-model="newFile.description"
            type="textarea"
            filled
            label="Descripción (opcional)"
            rows="2"
          />
        </q-card-section>

        <q-card-actions align="right">
          <q-btn
            flat
            label="Cancelar"
            color="grey-7"
            @click="cancelUploadFile"
          />
          <q-btn
            color="primary"
            label="Subir y Agregar"
            :loading="uploading"
            @click="uploadAndSaveFile"
          />
        </q-card-actions>
      </q-card>
    </q-dialog>

    <!-- Botones de Acción -->
    <div class="row justify-between items-center q-mt-lg q-pt-md" style="border-top: 1px solid rgba(0,0,0,0.12)">
      <div class="text-caption text-grey-6">
        <q-icon name="info" size="14px" class="q-mr-xs" />
        Los campos marcados con * son obligatorios
      </div>
      <div class="row q-gutter-sm">
        <q-btn
          flat
          label="Limpiar formulario"
          color="grey-7"
          icon="refresh"
          @click="reset"
        />
        <q-btn
          type="submit"
          color="primary"
          unelevated
          :label="isEditMode ? 'Actualizar capacitación' : 'Crear capacitación'"
          icon="check"
          :loading="false"
          class="q-px-xl"
        />
      </div>
    </div>
  </q-form>
</template>

<script setup lang="ts">
import { reactive, ref, onMounted, computed, watch } from 'vue';
import { useQuasar } from 'quasar';
import MaterialViewer from '../../../shared/components/MaterialViewer.vue';
import type { Material } from '../../../shared/components/MaterialViewer.vue';
import { materialsService } from '../../../infrastructure/http/materials/materials.service';
import { useMaterialUrl } from '../../../shared/composables/useMaterialUrl';

// Re-exportar tipos desde el módulo de tipos para mantener compatibilidad
export type {
  EvaluationOption,
  QuestionOption,
  InlineEvaluation,
  TrainingFormModel,
} from './TrainingForm.types';

const props = withDefaults(
  defineProps<{
    initialData?: {
      id?: string;
      title?: string;
      description?: string;
      type?: 'standard' | 'certified' | 'survey' | null;
      modality?: 'online' | 'onsite' | 'hybrid' | null;
      location?: string;
      durationHours?: number | null;
      capacity?: number | null;
      instructor?: string;
      area?: string;
      targetAudience?: string | null;
      startDate?: string;
      endDate?: string;
      coverImageUrl?: string;
      promoVideoUrl?: string;
      evaluations?: Array<{ id: number }>;
    } | null;
    initialMaterials?: Material[];
    initialEvaluationId?: number | null;
    initialEvaluationInline?: InlineEvaluation | null;
  }>(),
  {
    initialData: null,
    initialMaterials: () => [],
    initialEvaluationId: null,
    initialEvaluationInline: null,
  }
);

const emit = defineEmits<{
  submit: [TrainingFormModel, Material[]];
}>();

const $q = useQuasar();
const showImagePreview = ref(false);

// Composables
const { buildFullUrl } = useMaterialUrl();

// Detectar modo edición
const isEditMode = computed(() => {
  return !!props.initialData?.id;
});

// Estados para videos
const showAddVideoDialog = ref(false);
const editingVideoIndex = ref<number | null>(null);
const videos = ref<Material[]>([]);

// Estados para archivos
const showUploadFileDialog = ref(false);
const editingFileIndex = ref<number | null>(null);
const files = ref<Material[]>([]);
const uploading = ref(false);
const uploadProgress = ref(0);

// Materiales combinados (para compatibilidad con el emit)
const materials = computed(() => [...videos.value, ...files.value]);

// Estados de validación en tiempo real
const titleError = ref('');
const descriptionError = ref('');

const newVideo = reactive<Material>({
  name: '',
  url: '',
  type: 'VIDEO',
  description: '',
  order: 0,
});

const newFile = reactive<{
  name: string;
  type: string;
  file: File | null;
  description: string;
}>({
  name: '',
  type: 'PDF',
  file: null,
  description: '',
});

const fileTypes = [
  { label: 'PDF', value: 'PDF' },
  { label: 'Imagen', value: 'IMAGE' },
];

const trainingTypes = [
  { label: 'Capacitación estándar', value: 'standard' },
  { label: 'Capacitación certificada', value: 'certified' },
  { label: 'Encuesta', value: 'survey' },
];

const modalities = [
  { label: 'Online', value: 'online' },
  { label: 'Presencial', value: 'onsite' },
  { label: 'Mixta', value: 'hybrid' },
];

const targetAudiences = [
  'Conductores',
  'Administrativos',
  'Operadores',
  'Clientes',
  'Proveedores',
  'Otros',
];

// Tipos de pregunta (RF-16)
const questionTypes = [
  { label: 'Única respuesta', value: 1 },
  { label: 'Respuesta múltiple', value: 2 },
  { label: 'Selección de imagen', value: 3 },
  { label: 'Falso o Verdadero', value: 4 },
  { label: 'Sí o No', value: 5 },
];

// Computed para verificar si hay evaluación (siempre inline ahora)
const hasEvaluation = computed(() => {
  return !!form.evaluationInline && form.evaluationInline.preguntas.length > 0;
});

/**
 * Calcula automáticamente el puntaje total de la evaluación
 * como la suma de los puntajes de todas las preguntas
 */
const calculatedPuntajeTotal = computed(() => {
  if (!form.evaluationInline?.preguntas || form.evaluationInline.preguntas.length === 0) {
    return 0;
  }
  return form.evaluationInline.preguntas.reduce(
    (sum, pregunta) => sum + (pregunta.puntaje || 0),
    0
  );
});

// Inicializar evaluación inline si no existe (para modo edición)
onMounted(() => {
  if (!form.evaluationInline) {
    form.evaluationInline = {
      titulo: '',
      descripcion: '',
      intentosPermitidos: 1,
      mostrarResultados: true,
      mostrarRespuestasCorrectas: false,
      puntajeTotal: 100,
      minimoAprobacion: 70,
      orden: 0,
      preguntas: [
        {
          tipoPreguntaId: 1,
          enunciado: '',
          puntaje: 1,
          orden: 0,
          requerida: true,
          opciones: [
            { texto: '', esCorrecta: false, puntajeParcial: 0, orden: 0 },
            { texto: '', esCorrecta: false, puntajeParcial: 0, orden: 1 },
          ],
        },
      ],
    };
  }
});

// Funciones para manejar videos
function isValidVideoUrl(url: string): boolean {
  if (!url || !url.startsWith('http')) return false;
  const urlLower = url.toLowerCase();
  return (
    urlLower.includes('youtube.com') ||
    urlLower.includes('youtu.be') ||
    urlLower.includes('vimeo.com') ||
    urlLower.includes('drive.google.com') ||
    /\.(mp4|webm|ogg)$/i.test(urlLower)
  );
}

function previewVideo(url: string): void {
  // Abrir preview en nueva ventana o mostrar en modal
  window.open(url, '_blank');
}

function saveVideo(): void {
  if (!newVideo.name || !newVideo.url) {
    $q.notify({
      type: 'negative',
      message: 'Complete todos los campos requeridos',
      position: 'top',
    });
    return;
  }

  if (!isValidVideoUrl(newVideo.url)) {
    $q.notify({
      type: 'negative',
      message: 'La URL de video no es válida',
      position: 'top',
    });
    return;
  }

  if (editingVideoIndex.value !== null) {
    const existingVideo = videos.value[editingVideoIndex.value];
    if (existingVideo) {
      videos.value[editingVideoIndex.value] = {
        ...newVideo,
        id: existingVideo.id || generateId(),
        order: editingVideoIndex.value,
      };
    }
  } else {
    videos.value.push({
      ...newVideo,
      id: generateId(),
      order: videos.value.length,
    });
  }

  cancelAddVideo();
  $q.notify({
    type: 'positive',
    message: editingVideoIndex.value !== null ? 'Video actualizado' : 'Video agregado',
    position: 'top',
  });
}

function editVideo(index: number): void {
  editingVideoIndex.value = index;
  const video = videos.value[index];
  if (!video) return;
  newVideo.name = video.name;
  newVideo.url = video.url;
  newVideo.description = video.description || '';
  showAddVideoDialog.value = true;
}

function removeVideo(index: number): void {
  $q.dialog({
    title: 'Confirmar eliminación',
    message: '¿Está seguro de que desea eliminar este video?',
    cancel: true,
    persistent: true,
  }).onOk(() => {
    videos.value.splice(index, 1);
    videos.value.forEach((v, idx) => {
      v.order = idx;
    });
    $q.notify({
      type: 'positive',
      message: 'Video eliminado',
      position: 'top',
    });
  });
}

function cancelAddVideo(): void {
  showAddVideoDialog.value = false;
  editingVideoIndex.value = null;
  newVideo.name = '';
  newVideo.url = '';
  newVideo.description = '';
  newVideo.order = 0;
}

// Funciones para manejar archivos
function getFileUploadLabel(): string {
  if (newFile.type === 'PDF') {
    return 'Seleccionar archivo PDF *';
  }
  return 'Seleccionar imagen *';
}

function getFileAcceptTypes(): string {
  if (newFile.type === 'PDF') {
    return '.pdf';
  }
  return 'image/*';
}

function isImageFile(file: File): boolean {
  return file.type.startsWith('image/');
}

function getFilePreviewUrl(file: File): string {
  return URL.createObjectURL(file);
}

function previewFile(file: File | null): void {
  if (!file) return;
  if (isImageFile(file)) {
    const url = getFilePreviewUrl(file);
    $q.dialog({
      component: 'div',
      componentProps: {
        style: 'text-align: center; padding: 20px;',
      },
    }).onOk(() => {
      URL.revokeObjectURL(url);
    });
    // Mostrar imagen en un modal simple
    window.open(url, '_blank');
  }
}

function handleFileSelected(file: File | null): void {
  if (file) {
    // Validar tipo
    if (newFile.type === 'PDF' && file.type !== 'application/pdf') {
      $q.notify({
        type: 'negative',
        message: 'El archivo seleccionado no es un PDF',
        position: 'top',
      });
      newFile.file = null;
      return;
    }
    if (newFile.type === 'IMAGE' && !isImageFile(file)) {
      $q.notify({
        type: 'negative',
        message: 'El archivo seleccionado no es una imagen',
        position: 'top',
      });
      newFile.file = null;
      return;
    }
    // Validar tamaño (10MB)
    if (file.size > 10 * 1024 * 1024) {
      $q.notify({
        type: 'negative',
        message: 'El archivo excede el tamaño máximo de 10MB',
        position: 'top',
      });
      newFile.file = null;
      return;
    }
  }
}

async function uploadAndSaveFile(): Promise<void> {
  if (!newFile.name || !newFile.file) {
    $q.notify({
      type: 'negative',
      message: 'Complete todos los campos requeridos',
      position: 'top',
    });
    return;
  }

  uploading.value = true;
  uploadProgress.value = 0;

  try {
    const response = await materialsService.uploadFile(
      newFile.file,
      (progress) => {
        uploadProgress.value = progress;
      },
    );

    // Guardar URL relativa para el backend, pero construir URL completa para visualización
    // El backend espera URLs relativas o URLs completas válidas
    // Para archivos locales, guardamos la URL relativa que viene del backend
    // Para visualización, construimos la URL completa
    const relativeUrl = response.url; // El backend ya retorna la URL relativa
    const fullUrl = buildFullUrl(relativeUrl); // Para visualización en el frontend

    // Tipo extendido para incluir URL relativa temporal
    interface MaterialWithRelativeUrl extends Material {
      _relativeUrl?: string;
    }
    
    const fileMaterial: MaterialWithRelativeUrl = {
      id: generateId(),
      name: newFile.name,
      url: fullUrl, // URL completa para visualización en el frontend
      type: newFile.type as 'PDF' | 'IMAGE',
      description: newFile.description || '',
      order: files.value.length,
      // Guardar también la URL relativa para cuando se envíe al backend
      _relativeUrl: relativeUrl,
    };

    if (editingFileIndex.value !== null) {
      files.value[editingFileIndex.value] = fileMaterial;
    } else {
      files.value.push(fileMaterial);
    }

    cancelUploadFile();
    $q.notify({
      type: 'positive',
      message: editingFileIndex.value !== null ? 'Archivo actualizado' : 'Archivo subido exitosamente',
      position: 'top',
    });
  } catch (error) {
    console.error('Error al subir archivo:', error);
    $q.notify({
      type: 'negative',
      message: error instanceof Error ? error.message : 'Error al subir el archivo',
      position: 'top',
    });
  } finally {
    uploading.value = false;
    uploadProgress.value = 0;
  }
}

function editFile(index: number): void {
  editingFileIndex.value = index;
  const file = files.value[index];
  if (!file) return;
  newFile.name = file.name;
  newFile.type = file.type as 'PDF' | 'IMAGE';
  newFile.description = file.description || '';
  newFile.file = null; // No se puede editar el archivo, solo los metadatos
  showUploadFileDialog.value = true;
}

function removeFile(index: number): void {
  $q.dialog({
    title: 'Confirmar eliminación',
    message: '¿Está seguro de que desea eliminar este archivo?',
    cancel: true,
    persistent: true,
  }).onOk(() => {
    files.value.splice(index, 1);
    files.value.forEach((f, idx) => {
      f.order = idx;
    });
    $q.notify({
      type: 'positive',
      message: 'Archivo eliminado',
      position: 'top',
    });
  });
}

function cancelUploadFile(): void {
  showUploadFileDialog.value = false;
  editingFileIndex.value = null;
  newFile.name = '';
  newFile.type = 'PDF';
  newFile.file = null;
  newFile.description = '';
  uploadProgress.value = 0;
}

// Funciones para manejar preguntas y opciones
function addQuestion(): void {
  if (!form.evaluationInline) return;
  const newQuestion: QuestionOption = {
    tipoPreguntaId: 1,
    enunciado: '',
    puntaje: 1,
    orden: form.evaluationInline.preguntas.length,
    requerida: true,
    opciones: [
      { texto: '', esCorrecta: false, puntajeParcial: 0, orden: 0 },
      { texto: '', esCorrecta: false, puntajeParcial: 0, orden: 1 },
    ],
  };
  form.evaluationInline.preguntas.push(newQuestion);
}

function removeQuestion(index: number): void {
  if (!form.evaluationInline) return;
  if (form.evaluationInline.preguntas.length > 1) {
    form.evaluationInline.preguntas.splice(index, 1);
    // Reordenar
    form.evaluationInline.preguntas.forEach((p, i) => {
      p.orden = i;
    });
  } else {
    $q.notify({
      type: 'warning',
      message: 'Debe tener al menos una pregunta (RF-08)',
      position: 'top',
      timeout: 3000,
    });
  }
}

function addOption(preguntaIndex: number): void {
  if (!form.evaluationInline) return;
  const pregunta = form.evaluationInline.preguntas[preguntaIndex];
  if (!pregunta) return;
  pregunta.opciones.push({
    texto: '',
    esCorrecta: false,
    puntajeParcial: 0,
    orden: pregunta.opciones.length,
  });
}

function removeOption(preguntaIndex: number, opcionIndex: number): void {
  if (!form.evaluationInline) return;
  const pregunta = form.evaluationInline.preguntas[preguntaIndex];
  if (!pregunta) return;
  if (pregunta.opciones.length > 1) {
    pregunta.opciones.splice(opcionIndex, 1);
    // Reordenar
    pregunta.opciones.forEach((o, i) => {
      o.orden = i;
    });
  } else {
    $q.notify({
      type: 'warning',
      message: 'Cada pregunta debe tener al menos una opción',
      position: 'top',
      timeout: 3000,
    });
  }
}

const form = reactive<TrainingFormModel>({
  title: '',
  description: '',
  type: null,
  modality: null,
  location: '',
  durationHours: null,
  capacity: null,
  instructor: '',
  area: '',
  targetAudience: 'Conductores',
  startDate: '',
  endDate: '',
  coverImageUrl: '',
  promoVideoUrl: '',
  evaluationId: null, // RF-09: Evaluación obligatoria (para vincular existente)
  evaluationInline: {
    titulo: '',
    descripcion: '',
    intentosPermitidos: 1,
    mostrarResultados: true,
    mostrarRespuestasCorrectas: false,
    puntajeTotal: 100,
    minimoAprobacion: 70,
    orden: 0,
    preguntas: [
      {
        tipoPreguntaId: 1,
        enunciado: '',
        puntaje: 1,
        orden: 0,
        requerida: true,
        opciones: [
          { texto: '', esCorrecta: false, puntajeParcial: 0, orden: 0 },
          { texto: '', esCorrecta: false, puntajeParcial: 0, orden: 1 },
        ],
      },
    ],
  }, // RF-09: Evaluación a crear inline
  attachments: [],
  links: [],
});

function reset() {
  form.title = '';
  form.description = '';
  form.type = null;
  form.modality = null;
  form.location = '';
  form.durationHours = null;
  form.capacity = null;
  form.instructor = '';
  form.area = '';
  form.targetAudience = 'Conductores';
  form.startDate = '';
  form.endDate = '';
  form.coverImageUrl = '';
  form.promoVideoUrl = '';
  form.evaluationId = null;
  form.evaluationInline = {
    titulo: '',
    descripcion: '',
    intentosPermitidos: 1,
    mostrarResultados: true,
    mostrarRespuestasCorrectas: false,
    puntajeTotal: 100,
    minimoAprobacion: 70,
    orden: 0,
    preguntas: [
      {
        tipoPreguntaId: 1,
        enunciado: '',
        puntaje: 1,
        orden: 0,
        requerida: true,
        opciones: [
          { texto: '', esCorrecta: false, puntajeParcial: 0, orden: 0 },
          { texto: '', esCorrecta: false, puntajeParcial: 0, orden: 1 },
        ],
      },
    ],
  };
  form.attachments = [];
  form.links = [];
  videos.value = [];
  files.value = [];
  showImagePreview.value = false;
  titleError.value = '';
  descriptionError.value = '';
}

// Inicializar formulario con datos existentes (modo edición)
function initializeFormWithData() {
  if (!props.initialData) return;

  const data = props.initialData;

  form.title = data.title || '';
  form.description = data.description || '';
  form.type = data.type ?? null;
  form.modality = data.modality ?? null;
  form.location = data.location || '';
  form.durationHours = data.durationHours ?? null;
  form.capacity = data.capacity ?? null;
  form.instructor = data.instructor || '';
  form.area = data.area || '';
  form.targetAudience = data.targetAudience ?? 'Conductores';
  form.startDate = data.startDate || '';
  form.endDate = data.endDate || '';
  form.coverImageUrl = data.coverImageUrl || '';
  form.promoVideoUrl = data.promoVideoUrl || '';

  // Cargar materiales iniciales y separar videos de archivos
  if (props.initialMaterials && props.initialMaterials.length > 0) {
    videos.value = props.initialMaterials.filter(m => m.type === 'VIDEO');
    files.value = props.initialMaterials.filter(m => m.type !== 'VIDEO');
  }

  // Cargar evaluación inline si se proporciona (modo edición)
  if (props.initialEvaluationInline) {
    form.evaluationInline = { ...props.initialEvaluationInline };
  }
}

// Inicializar cuando se monta el componente o cambian los props
watch(
  () => props.initialData,
  () => {
    initializeFormWithData();
  },
  { immediate: true }
);

// También inicializar materiales cuando cambien
watch(
  () => props.initialMaterials,
  (newMaterials) => {
    if (newMaterials && newMaterials.length > 0) {
      videos.value = newMaterials.filter(m => m.type === 'VIDEO');
      files.value = newMaterials.filter(m => m.type !== 'VIDEO');
    }
  },
  { immediate: true }
);



function onSubmit() {
  // Validar evaluación obligatoria (RF-09) - siempre inline ahora
  if (!form.evaluationInline || !form.evaluationInline.titulo) {
    $q.notify({
      type: 'warning',
      message: 'Debe completar el título de la evaluación',
      position: 'top',
      timeout: 3000,
    });
    return;
  }

  if (!form.evaluationInline.preguntas || form.evaluationInline.preguntas.length === 0) {
    $q.notify({
      type: 'warning',
      message: 'Debe agregar al menos una pregunta (RF-08)',
      position: 'top',
      timeout: 3000,
    });
    return;
  }

    // Validar que todas las preguntas tengan enunciado y al menos una opción correcta
    for (let i = 0; i < form.evaluationInline.preguntas.length; i++) {
      const pregunta = form.evaluationInline.preguntas[i];
      if (!pregunta) {
        $q.notify({
          type: 'warning',
          message: `Error en la pregunta ${i + 1}`,
          position: 'top',
          timeout: 3000,
        });
        return;
      }

      if (!pregunta.enunciado) {
        $q.notify({
          type: 'warning',
          message: `La pregunta ${i + 1} debe tener un enunciado`,
          position: 'top',
          timeout: 3000,
        });
        return;
      }

      if (!pregunta.opciones || pregunta.opciones.length === 0) {
        $q.notify({
          type: 'warning',
          message: `La pregunta ${i + 1} debe tener al menos una opción`,
          position: 'top',
          timeout: 3000,
        });
        return;
      }

      const tieneOpcionCorrecta = pregunta.opciones.some((o) => o.esCorrecta && o.texto);
      if (!tieneOpcionCorrecta) {
        $q.notify({
          type: 'warning',
          message: `La pregunta ${i + 1} debe tener al menos una opción correcta`,
          position: 'top',
          timeout: 3000,
        });
        return;
      }

      // Validar que todas las opciones tengan texto
      for (let j = 0; j < pregunta.opciones.length; j++) {
        const opcion = pregunta.opciones[j];
        if (!opcion || !opcion.texto) {
          $q.notify({
            type: 'warning',
            message: `La pregunta ${i + 1}, opción ${j + 1} debe tener texto`,
            position: 'top',
            timeout: 3000,
          });
          return;
        }
      }
    }

  emit('submit', { ...form }, materials.value);
}

// Funciones de attachments removidas - ya no se usan en el formulario actual

function addLink() {
  form.links.push({
    id: Date.now().toString() + Math.random().toString(16).slice(2),
    label: '',
    url: '',
  });
}

function removeLink(index: number) {
  form.links.splice(index, 1);
}

function validateTitle() {
  const title = form.title?.trim() ?? '';
  if (!title) {
    titleError.value = 'El título es obligatorio';
    return false;
  }
  if (title.length < 5) {
    titleError.value = 'El título debe tener al menos 5 caracteres';
    return false;
  }
  if (title.length > 200) {
    titleError.value = 'El título no puede exceder 200 caracteres';
    return false;
  }
  titleError.value = '';
  return true;
}

function validateDescription() {
  const desc = form.description?.trim() ?? '';
  if (desc && desc.length < 20) {
    descriptionError.value = 'La descripción debe tener al menos 20 caracteres';
    return false;
  }
  if (desc && desc.length > 2000) {
    descriptionError.value = 'La descripción no puede exceder 2000 caracteres';
    return false;
  }
  descriptionError.value = '';
  return true;
}

function validateImageUrl() {
  if (form.coverImageUrl && !form.coverImageUrl.startsWith('http')) {
    // Podrías agregar validación adicional aquí
  }
}

function handleDurationChange(value: string | number | null) {
  // Convertir a entero si tiene valor
  if (value !== null && value !== undefined && value !== '') {
    form.durationHours = Math.round(Number(value));
  } else {
    form.durationHours = null;
  }
}

// Funciones para gestión de materiales
function getMaterialTypeColor(type: string): string {
  switch (type) {
    case 'PDF':
      return 'negative';
    case 'IMAGE':
      return 'primary';
    case 'VIDEO':
      return 'purple';
    case 'DOC':
      return 'blue';
    case 'LINK':
      return 'teal';
    case 'PRESENTATION':
      return 'orange';
    case 'AUDIO':
      return 'pink';
    default:
      return 'grey';
  }
}

function getMaterialTypeLabel(type: string): string {
  const typeMap: Record<string, string> = {
    PDF: 'PDF',
    IMAGE: 'Imagen',
    VIDEO: 'Video',
    DOC: 'Documento Word',
    LINK: 'Enlace externo',
    PRESENTATION: 'Presentación',
    AUDIO: 'Audio',
  };
  return typeMap[type] || type;
}



function generateId(): string {
  return Date.now().toString() + Math.random().toString(16).slice(2);
}
</script>

<style scoped lang="scss">
.q-card {
  transition: box-shadow 0.3s ease;
}

.q-card:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.empty-materials {
  border: 2px dashed rgba(0, 0, 0, 0.12);
  border-radius: 8px;
  background-color: rgba(0, 0, 0, 0.02);
}

.materials-list {
  .material-card {
    transition: all 0.2s ease;

    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
  }

  .drag-handle {
    cursor: move;
    opacity: 0.6;
    transition: opacity 0.2s ease;

    &:hover {
      opacity: 1;
    }
  }

  .material-preview-container {
    width: 120px;
    min-width: 120px;
  }

  .material-info {
    min-width: 0; // Permite que el texto se trunque
  }

  .material-actions {
    flex-shrink: 0;
  }
}

body.body--dark {
  .empty-materials {
    border-color: rgba(255, 255, 255, 0.12);
    background-color: rgba(255, 255, 255, 0.05);
  }
}

// Estilos para la sección de evaluación
.evaluation-section {
  transition: all 0.3s ease;

  &.evaluation-warning {
    border: 2px solid rgba(var(--q-warning-rgb), 0.3);
    background-color: rgba(var(--q-warning-rgb), 0.05);
  }

  &.evaluation-selected {
    border: 2px solid rgba(var(--q-primary-rgb), 0.3);
    background-color: rgba(var(--q-primary-rgb), 0.02);
  }
}

// Mejoras visuales para el banner de advertencia
.bg-warning-1 {
  background-color: rgba(var(--q-warning-rgb), 0.1) !important;
}

body.body--dark {
  .evaluation-section {
    &.evaluation-warning {
      border-color: rgba(var(--q-warning-rgb), 0.4);
      background-color: rgba(var(--q-warning-rgb), 0.08);
    }

    &.evaluation-selected {
      border-color: rgba(var(--q-primary-rgb), 0.4);
      background-color: rgba(var(--q-primary-rgb), 0.05);
    }
  }
}

// Estilos para campos readonly compatibles con modo oscuro
.readonly-field {
  .q-field__control {
    opacity: 0.7;
    cursor: not-allowed;
  }
}

body.body--light {
  .readonly-field {
    .q-field__control {
      background-color: rgba(0, 0, 0, 0.04);
    }
  }
}

body.body--dark {
  .readonly-field {
    .q-field__control {
      background-color: rgba(255, 255, 255, 0.05);
    }
  }
}
</style>
